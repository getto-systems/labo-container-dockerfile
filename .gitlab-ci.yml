image: buildpack-deps:disco

test:
  only:
    - merge_requests

  image: docker:stable

  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_CONTENT_TRUST: 1
  services:
    - docker:dind

  cache:
    paths:
      - .cache

  before_script:
    - apk -Uuv add bash git curl tar sed grep
    - ./bin/install_dockle.sh
    - ./bin/install_trivy.sh
    - export HOME=$(pwd)
  script:
    - docker build -t getto/labo-container:${CI_COMMIT_SHORT_SHA} .
    - dockle --exit-code 1 getto/labo-container:${CI_COMMIT_SHORT_SHA}
    - trivy --exit-code 1 --quiet --ignore-unfixed --auto-refresh getto/labo-container:${CI_COMMIT_SHORT_SHA}

update:
  only:
    - schedules

  image: docker:stable

  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_CONTENT_TRUST: 1
  services:
    - docker:dind

  cache:
    paths:
      - .cache

  before_script:
    - apk -Uuv add bash git curl tar sed grep
    - ./bin/install_dockle.sh
    - ./bin/install_trivy.sh
    - export HOME=$(pwd)
  script:
    - docker build -t getto/labo-container:${CI_COMMIT_SHORT_SHA} .
    - dockle --exit-code 1 getto/labo-container:${CI_COMMIT_SHORT_SHA}
    - trivy --exit-code 1 --quiet --ignore-unfixed --auto-refresh getto/labo-container:${CI_COMMIT_SHORT_SHA}
    - ./bin/append_date_to_release_version.sh
    - ./bin/push_tags.sh

release:
  only:
    - release@getto-systems-labo/container/dockerfile
  script:
    - ./bin/push_tags.sh
