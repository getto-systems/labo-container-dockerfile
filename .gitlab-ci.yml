image: buildpack-deps:disco

test:
  only:
    - merge_requests

  image: docker:stable

  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_CONTENT_TRUST: 1
  services:
    - docker:dind

  cache:
    paths:
      - .cache

  before_script:
    - ./bin/install_ci_tools.sh
  script:
    - ./bin/test.sh

update:
  only:
    - schedules

  image: docker:stable

  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_CONTENT_TRUST: 1
  services:
    - docker:dind

  cache:
    paths:
      - .cache

  before_script:
    - ./bin/install_ci_tools.sh
  script:
    - ./bin/test.sh
    - ./bin/append_date_to_release_version.sh
    - ./bin/push_tags.sh

release:
  only:
    - release@getto-systems-labo/container/dockerfile
  script:
    - ./bin/push_tags.sh
